<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>nixos VM in lxd</title><link rel="stylesheet" href="/site.css"></head><body><div class="container"><header style="padding:1rem;border-bottom:1px solid #ddd"><h1>nixos VM in lxd</h1><nav><a href="/">home</a>&nbsp<a href="/archive.html">archive</a>&nbsp</nav></header><main class="article"><span style="display: inline-block; text-align: right; width: 100%;">Posted on 2025/01/09<br>tagged </span><p></p><p>Setting up VM images with nixos is incredibly powerful when coupled with declarative nature of nix language itself.</p>
<p>I am using it for running homelab type services and lab type setups. Here is how I have it working for me:</p>
<h1>Create the VM</h1>
<p>This is a snippet from a shell script I use</p>
<pre><code>name=nixos1
img=nixos/24.05
cpu=4
mem=8
disk=100
incus launch images:$img $name \
    --vm \
    -c limits.cpu=4 \
    -c limits.memory=${mem}GiB \
    -c security.secureboot=false \
    --device root,size=${disk}GiB
</code></pre>
<h1>Configure the VM</h1>
<p>Assuming you have some nixos configuration, you can upload the config
and update the VM.</p>
<pre><code>incus file push ./configuration.nix $name/etc/nixos/configuration.nix
incus exec &quot;$name&quot; -- /run/current-system/sw/bin/bash -i -c &quot;nixos-rebuild switch&quot;
</code></pre>
<h1>Example Configuration</h1>
<p>configuration.nix</p>
<pre><code>    { config, pkgs, lib, modulesPath, ... }:

    {
      imports =
        [
          # Include the default lxd configuration.
          &quot;${modulesPath}/virtualisation/lxd-virtual-machine.nix&quot;
          # Include the container-specific autogenerated configuration.
          ./lxd.nix
        ];

      boot.supportedFilesystems = [ &quot;nfs&quot; ];

      networking = {
        hostName = &quot;nixos1&quot;; # Define your hostname.
        dhcpcd.enable = false;
        useDHCP = false;
        useHostResolvConf = false;
      };


      # For plex...
      virtualisation.oci-containers.backend = &quot;docker&quot;;

      virtualisation.oci-containers.containers = {
        plex = {
          image = &quot;plexinc/pms-docker&quot;;
          volumes = [
            &quot;/srv/plex/config:/config&quot;
            &quot;/srv/plex/tmp:/transcode&quot;
            &quot;/data/movies:/data/movies&quot;
            &quot;/data/TV:/data/TV&quot;
          ];
          extraOptions = [
            &quot;--network=host&quot;
          ];
          environment = {
            PLEX_CLAIM = &quot;claim-XXX&quot;;
            TZ = &quot;America/Los_Angeles&quot;;
          };
        };
      };

      programs.bash.enableCompletion = true;
      services.jellyfin.enable = true;

      environment.systemPackages = with pkgs; [
        vim
        wget
        curl
        emacs
        git

      ];

      services.openssh.enable = true;
      networking.firewall.enable = false;

      systemd.network = {
        enable = true;
        networks.&quot;50-enp5s0&quot; = {
          matchConfig.Name = &quot;enp5s0&quot;;
          networkConfig = {
            DHCP = &quot;ipv4&quot;;
            IPv6AcceptRA = true;
          };
          linkConfig.RequiredForOnline = &quot;routable&quot;;
        };
      };


      system.stateVersion = &quot;24.05&quot;; # Did you read the comment?
    }
</code></pre>
</main><footer style="padding:1rem;border-top:1px solid #ddd;margin-top:2rem"><small>Â© Sigmonsays</small></footer></div></body></html>