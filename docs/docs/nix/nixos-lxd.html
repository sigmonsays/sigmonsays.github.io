<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/assets/css/bahunya.css">
<link rel="stylesheet" href="/assets/css/board.css">
<link rel="stylesheet" href="/assets/css/highlight.css">
<link rel="stylesheet" href="/assets/css/site.css">

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <title>nixos VM in lxd</title>
  <meta name="title" content="nixos VM in lxd" />
  <meta name="description" content="a few things to remember" />
  <meta name="keywords" content="go, nix, linux" />
</head>

<body>
  <nav>
    <a id="brand" href="/">Home</a>
    <a href="/projects/">projects</a>
  </nav>
  <header>
    <h1>nixos VM in lxd</h1>
  </header>
  <article><p>Setting up VM images with nixos is incredibly powerful when coupled with declarative nature of nix language itself.</p>
<p>I am using it for running homelab type services and lab type setups. Here is how I have it working for me:</p>
<h1 id="create-the-vm">Create the VM <a class="anchor" href="#create-the-vm"> </a></h1>
<p>This is a snippet from a shell script I use</p>
<pre><code>name=nixos1
img=nixos/24.05
cpu=4
mem=8
disk=100
incus launch images:$img $name \
    --vm \
    -c limits.cpu=4 \
    -c limits.memory=${mem}GiB \
    -c security.secureboot=false \
    --device root,size=${disk}GiB
</code></pre>
<h1 id="configure-the-vm">Configure the VM <a class="anchor" href="#configure-the-vm"> </a></h1>
<p>Assuming you have some nixos configuration, you can upload the config<br />
and update the VM.</p>
<pre><code>incus file push ./configuration.nix $name/etc/nixos/configuration.nix
incus exec &quot;$name&quot; -- /run/current-system/sw/bin/bash -i -c &quot;nixos-rebuild switch&quot;
</code></pre>
<h1 id="example-configuration">Example Configuration <a class="anchor" href="#example-configuration"> </a></h1>
<p>configuration.nix</p>
<pre><code>    { config, pkgs, lib, modulesPath, ... }:

    {
      imports =
        [
          # Include the default lxd configuration.
          &quot;${modulesPath}/virtualisation/lxd-virtual-machine.nix&quot;
          # Include the container-specific autogenerated configuration.
          ./lxd.nix
        ];

      boot.supportedFilesystems = [ &quot;nfs&quot; ];

      networking = {
        hostName = &quot;nixos1&quot;; # Define your hostname.
        dhcpcd.enable = false;
        useDHCP = false;
        useHostResolvConf = false;
      };


      # For plex...
      virtualisation.oci-containers.backend = &quot;docker&quot;;

      virtualisation.oci-containers.containers = {
        plex = {
          image = &quot;plexinc/pms-docker&quot;;
          volumes = [
            &quot;/srv/plex/config:/config&quot;
            &quot;/srv/plex/tmp:/transcode&quot;
            &quot;/data/movies:/data/movies&quot;
            &quot;/data/TV:/data/TV&quot;
          ];
          extraOptions = [
            &quot;--network=host&quot;
          ];
          environment = {
            PLEX_CLAIM = &quot;claim-XXX&quot;;
            TZ = &quot;America/Los_Angeles&quot;;
          };
        };
      };

      programs.bash.enableCompletion = true;
      services.jellyfin.enable = true;

      environment.systemPackages = with pkgs; [
        vim
        wget
        curl
        emacs
        git

      ];

      services.openssh.enable = true;
      networking.firewall.enable = false;

      systemd.network = {
        enable = true;
        networks.&quot;50-enp5s0&quot; = {
          matchConfig.Name = &quot;enp5s0&quot;;
          networkConfig = {
            DHCP = &quot;ipv4&quot;;
            IPv6AcceptRA = true;
          };
          linkConfig.RequiredForOnline = &quot;routable&quot;;
        };
      };


      system.stateVersion = &quot;24.05&quot;; # Did you read the comment?
    }
</code></pre>
</article>
  <footer>
    Copyright &copy; sigmonsays Â·
  </footer>
  <script type="application/javascript" src="/assets/js/highlight.js"></script>
<script type="application/javascript" src="/assets/js/umbrella.js"></script>
<script type="application/javascript" src="/assets/js/live.js"></script>

  <script>
    hljs.highlightAll();
  </script>
</body>

</html>
